Analisando o arquivo routes.ts que você enviou, foquei na lógica de processamento de pontos e geração de relatórios. Aqui está uma avaliação técnica detalhada do seu "coração" de cálculo:

1. Pontos Fortes do Código

Cálculo Noturno Preciso: Você implementou a função calculateNightOverlap para identificar minutos dentro do intervalo noturno (22h às 05h). Além disso, aplica corretamente o fator de redução de 1.1428 para converter tempo real em tempo de jornada.


Tratamento de Feriados e DSR: O sistema busca feriados no banco de dados para cada dia do intervalo e identifica fins de semana usando isWeekend da biblioteca date-fns. Isso é fundamental para o cálculo automático do DSR e para evitar descontos indevidos em dias não úteis.


Estrutura de Auditoria: Existe uma rota dedicada (/api/punches/:id/adjust) que exige uma justificativa (reason) para qualquer alteração de ponto, salvando o log de auditoria logo em seguida. Isso cumpre a exigência legal de rastreabilidade.

2. Riscos Jurídicos e Sugestões de Ajuste
Apesar de bem estruturado, encontrei alguns pontos que podem gerar problemas em uma fiscalização ou processo trabalhista:

Tolerância da CLT (Art. 58): Não encontrei no código uma lógica explícita para a tolerância de 5 minutos por batida (limitado a 10 minutos diários). Se o funcionário entra às 08:04 e sai às 17:56, o sistema pode estar descontando 8 minutos, quando a lei diz que pequenas variações não devem ser consideradas.


Batidas Ímpares: Na rota de geração de relatórios, se houver um número ímpar de batidas no dia, o sistema parece ignorar a última batida ou não calcular o saldo corretamente para aquele dia. O ideal é que o sistema marque o dia como "Inconsistente" no espelho de ponto para alertar o RH.

Intervalo Intrajornada (Almoço): O código calcula a jornada total subtraindo as saídas das entradas, mas não há um alerta ou trava se o funcionário fizer menos de 1 hora de almoço (obrigatório para jornadas acima de 6h).

3. Exemplo Técnico no seu Código
No trecho de cálculo de totais, você usa:

TypeScript

const dailyNightMinutes = Math.round(nightOverlap * 1.1428);

Recomendação: Como você mencionou que atualizou para usar decimais, certifique-se de que essa variável dailyNightMinutes no banco de dados seja do tipo decimal ou float, e não integer, para não perder precisão no somatório mensal.